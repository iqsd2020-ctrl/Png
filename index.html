<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>أسلوبي - إعادة صياغة المقالات</title>
    <!-- Tailwind CSS (مُزال - يتم الاعتماد على الـ CSS المخصص بالأسفل) -->
    <!-- <script src="https://cdn.tailwindcss.com"></script> -->
    <!-- تحميل خط 'Cairo' لواجهة عربية واضحة -->
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap" rel="stylesheet">
    
    <style>
        /* --- قواعد Neumorphism الصارمة --- */
        
        :root {
            /* 1. الألوان الأساسية حسب القواعد */
            --primary-bg: #e0e5ec;
            --dark-shadow: #a3b1c6;
            --light-shadow: #ffffff;
            --font-color: #33373d;
            --accent-color: #0984e3;
            --error-color: #e74c3c;

            /* 2. الظلال حسب القواعد */
            /* ظل العناصر البارزة (للبطاقات والأزرار) */
            --outset-shadow: 6px 6px 12px var(--dark-shadow), -6px -6px 12px var(--light-shadow);

            /* ظل العناصر الغائرة (لحقول الإدخال أو عند الضغط) */
            --inset-shadow: inset 6px 6px 12px var(--dark-shadow), inset -6px -6px 12px var(--light-shadow);
        }

        /* --- إعادة الضبط والتنسيق العام --- */

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            outline: none; /* إزالة التحديد الخارجي */
        }

        body {
            font-family: 'Cairo', sans-serif;
            background-color: var(--primary-bg); /* تطبيق الخلفية الأساسية */
            color: var(--font-color); /* تطبيق لون الخط الأساسي */
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        /* --- الهيكل والتنسيق --- */

        .container {
            width: 100%;
            max-width: 1000px; /* يعادل max-w-5xl */
        }

        header {
            text-align: center;
            margin-bottom: 30px;
        }

        header h1 {
            font-size: 2.5rem; /* يعادل text-4xl/5xl */
            font-weight: 700;
            color: var(--accent-color); /* تطبيق اللون المميز */
        }

        header p {
            font-size: 1.1rem; /* يعادل text-lg */
            color: var(--font-color);
            opacity: 0.8;
            margin-top: 8px;
        }

        main {
            background: var(--primary-bg); /* لون العنصر نفس لون الخلفية */
            border-radius: 22px; /* زوايا ناعمة */
            padding: 30px; /* يعادل p-6 */
            width: 100%;
            /* تطبيق الظل البارز (Outset) */
            box-shadow: var(--outset-shadow);
            border: none; /* إزالة الحدود */
        }

        .grid-container {
            display: grid;
            grid-template-columns: 1fr;
            gap: 25px; /* يعادل gap-6 */
        }

        /* تنسيق حقول الإدخال (Textarea) */

        label {
            display: block;
            font-size: 1.1rem; /* text-lg */
            font-weight: 600;
            color: var(--font-color);
            margin-bottom: 12px;
        }

        textarea {
            width: 100%;
            height: 350px; /* يعادل h-96 */
            padding: 15px;
            font-family: 'Cairo', sans-serif;
            font-size: 1rem;
            color: var(--font-color);
            resize: vertical;
            
            /* تطبيق تصميم Neumorphism الغائر (Inset) */
            background: var(--primary-bg); /* نفس لون الخلفية */
            border: none; /* إزالة الحدود */
            border-radius: 15px; /* زوايا ناعمة */
            box-shadow: var(--inset-shadow);
        }

        textarea:read-only {
            /* يمكن إضافة تمييز بسيط للذي لا يمكن الكتابة عليه */
            opacity: 0.9;
        }

        /* تنسيق الأزرار */

        .button-container {
            margin-top: 25px;
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 20px;
        }

        button {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            min-width: 150px;
            padding: 12px 25px;
            font-family: 'Cairo', sans-serif;
            font-size: 1.05rem; /* text-lg */
            font-weight: 600;
            cursor: pointer;
            transition: box-shadow 0.2s ease-in-out, color 0.2s ease-in-out;

            /* تطبيق تصميم Neumorphism البارز (Outset) */
            background: var(--primary-bg); /* نفس لون الخلفية */
            border: none; /* إزالة الحدود */
            border-radius: 15px; /* زوايا ناعمة */
            box-shadow: var(--outset-shadow);
        }

        /* اللون المميز للزر الرئيسي */
        button#rewriteButton {
            color: var(--accent-color);
        }

        /* اللون العادي للزر الثانوي */
        button#copyButton {
            color: var(--font-color);
        }

        /* التفاعل (الضغط) حسب القاعدة: التحول إلى الغائر (Inset) */
        button:hover,
        button:active {
            box-shadow: var(--inset-shadow);
        }

        button:disabled {
            opacity: 0.7;
            cursor: not-allowed;
            /* إزالة الظل عند التعطيل لجعله مسطحًا */
            box-shadow: none; 
        }

        /* منطقة الخطأ */
        #errorMessage {
            margin-top: 20px;
            text-align: center;
            color: var(--error-color);
            font-weight: 600;
            min-height: 1.2em; /* حجز مساحة للرسالة */
        }
        
        /* تعريف شكل مؤشر التحميل (Spinner) */
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-left-color: var(--accent-color); /* استخدام اللون المميز */
            border-radius: 50%;
            width: 20px; /* أصغر قليلاً ليلائم الزر */
            height: 20px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }
        
        /* كلاس لإخفاء العناصر (بديل Tailwind) */
        .hidden {
            display: none;
        }
        
        /* استجابة للشاشات المتوسطة (Mobile-first) */
        @media (min-width: 768px) {
            .grid-container {
                grid-template-columns: 1fr 1fr;
            }
        }

    </style>
</head>
<body class="bg-gray-100 min-h-screen p-4 md:p-8">
    <!-- تم إزالة جميع كلاسات Tailwind من الـ HTML والاعتماد على الـ CSS أعلاه -->
    
    <div class="container">
        
        <!-- رأس التطبيق -->
        <header>
            <h1>أسلوبي</h1>
            <p>أعد صياغة نصوصك بروح العارفين</p>
        </header>

        <!-- منطقة العمل الرئيسية -->
        <main>

            <!-- الشبكة الخاصة بالمدخلات والمخرجات -->
            <div class="grid-container">
                
                <!-- عمود النص الأصلي -->
                <div>
                    <label for="inputText">النص الأصلي</label>
                    <textarea id="inputText"
                        placeholder="أدخل النص الذي ترغب في إعادة صياغته هنا..."></textarea>
                </div>

                <!-- عمود النص المُعاد صياغته -->
                <div>
                    <label for="outputText">النص بالصياغة الجديدة</label>
                    <textarea id="outputText"
                        placeholder="ستظهر النتيجة هنا..." readonly></textarea>
                </div>
            </div>

            <!-- منطقة الأزرار والتحميل -->
            <div class="button-container">
                
                <!-- زر إعادة الكتابة -->
                <button id="rewriteButton">
                    <!-- مؤشر التحميل (يظهر عند الحاجة) -->
                    <div id="loadingIndicator" class="spinner hidden"></div>
                    <span>إعادة كتابة</span>
                </button>

                <!-- زر نسخ النتيجة -->
                <button id="copyButton">
                    نسخ النص
                </button>
            </div>

            <!-- منطقة عرض الأخطاء -->
            <div id="errorMessage"></div>

        </main>
    </div>

    <script>
        // --- المنطق البرمجي للتطبيق ---
        // (لا حاجة لتعديل هذا الجزء، سيعمل كما هو)

        // الحصول على عناصر الواجهة
        const inputText = document.getElementById('inputText');
        const outputText = document.getElementById('outputText');
        const rewriteButton = document.getElementById('rewriteButton');
        const loadingIndicator = document.getElementById('loadingIndicator');
        const errorMessage = document.getElementById('errorMessage');
        const copyButton = document.getElementById('copyButton');

        // البرومبت (التوجيه) الخاص الذي طلبه المستخدم
        const SYSTEM_PROMPT = `اكتب النص بأسلوب عرفاني عميق، مستحضرًا عمق البيان العرفاني واللغة الرمزية التي تمزج بين الظاهر والباطن، والشهود والوجود. اجعل العبارات تنبض بروح التوحيد والكشف، بحيث يظهر في الكلام أثر التجلي، وسريان الحقيقة في مظاهر الخلق.

استخدم لغة عربية فصحى عالية، نقية من الخطأ، ملتزمة بالقواعد النحوية والصرفية والبلاغية.

اجعل الجمل تتنفس بنَفَسٍ صوفيٍ حكميٍّ، فيه الإشارات لا التصريحات، وفيه الجمع بين الضدين: الوحدة في الكثرة، والظاهر في الباطن، والنور في الظلمة.

يجب أن تتسم العبارات بالتوازن الإيقاعي، والاستعارات الكونية، والتماثل بين المعنى واللفظ، وأن تسودها نغمة الخشوع والجلال.

اجعل النص يعبّر عن الوعي بالحق، والانصهار في المحبوب، مع العروج من الكثرة إلى الوحدة. لا تُكثر الزخرفة، بل اجعل المعنى هو الجمال، واللفظ هو المظهر، والمعرفة هي القلب النابض للنص.

عند الكتابة، استحضر روح الحكمة العرفانية العالية، مع مراعاة وضوح المقاصد وسلامة التراكيب.

ملاحظة هامة: لا تقم بتشكيل النص (وضع الحركات) بشكل مبالغ فيه. اقتصر على الحركات الإعرابية الرئيسية والضرورية فقط لضبط المعنى.`;

        /**
         * دالة استدعاء Gemini API لإعادة صياغة النص
         */
        async function handleRewrite() {
            const userText = inputText.value;

            // التحقق من عدم إرسال نص فارغ
            if (!userText.trim()) {
                errorMessage.textContent = 'الرجاء إدخال نص لإعادة كتابته.';
                return;
            }

            // تفعيل وضع التحميل
            setLoadingState(true);

            // إعدادات الاتصال بالـ API
            const apiKey = "AIzaSyDdAtMBXcRXJL49QhAsJWPquDZXxi0KOHc"; // سيتم توفيره تلقائيًا في البيئة
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;

            const payload = {
                contents: [{ parts: [{ text: userText }] }],
                systemInstruction: {
                    parts: [{ text: SYSTEM_PROMPT }]
                },
                generationConfig: {
                    temperature: 0.7, // يمكن تعديل الإبداعية هنا
                }
            };

            try {
                // تنفيذ الاتصال بالـ API مع محاولات إعادة
                const response = await fetchWithBackoff(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    throw new Error(`API request failed with status: ${response.status}`);
                }

                const result = await response.json();
                
                // تحليل الاستجابة
                if (result.candidates && result.candidates.length > 0) {
                     if (result.candidates[0].finishReason === "SAFETY") {
                        errorMessage.textContent = "تعذر إنشاء النص بسبب قيود السلامة.";
                        outputText.value = "المحتوى المطلوب يتعارض مع سياسات السلامة.";
                     } else if (result.candidates[0].content && result.candidates[0].content.parts && result.candidates[0].content.parts[0].text) {
                        const generatedText = result.candidates[0].content.parts[0].text;
                        outputText.value = generatedText; // عرض النتيجة
                     } else {
                         throw new Error('No valid text found in API response.');
                     }
                } else if (result.promptFeedback && result.promptFeedback.blockReason) {
                    errorMessage.textContent = `تم حظر الطلب: ${result.promptFeedback.blockReason}`;
                    outputText.value = "تم حظر النص المدخل. يرجى تعديله والمحاولة مرة أخرى.";
                } else {
                    throw new Error('Invalid API response structure.');
                }

            } catch (error) {
                console.error('Error rewriting text:', error);
                errorMessage.textContent = `حدث خطأ: ${error.message}. يرجى المحاولة مرة أخرى.`;
                outputText.value = "حدث خطأ أثناء معالجة النص.";
            } finally {
                // إلغاء تفعيل وضع التحميل
                setLoadingState(false);
            }
        }
        
        /**
         * دالة لتنفيذ الاتصال مع محاولات إعادة عند الفشل (Exponential Backoff)
         */
        async function fetchWithBackoff(url, options, maxRetries = 3) {
            let delay = 1000; // 1 ثانية
            for (let i = 0; i < maxRetries; i++) {
                try {
                    const response = await fetch(url, options);
                    if (response.ok) {
                        return response; // نجاح
                    }
                    // إعادة المحاولة فقط لأخطاء الخادم (5xx) أو 429
                    if (response.status === 429 || response.status >= 500) {
                        // لا تسجل في الكونسول، انتظر وأعد المحاولة
                        await new Promise(res => setTimeout(res, delay));
                        delay *= 2; // مضاعفة مدة الانتظار
                    } else {
                        return response; // إرجاع الاستجابة للفشل (مثل 400)
                    }
                } catch (error) {
                    // أخطاء الشبكة
                    if (i === maxRetries - 1) throw error; // إطلاق الخطأ بعد آخر محاولة
                    await new Promise(res => setTimeout(res, delay));
                    delay *= 2;
                }
            }
            throw new Error('Max retries reached for API call.');
        }

        /**
         * دالة لتغيير حالة الواجهة (تحميل أو عادي)
         */
        function setLoadingState(isLoading) {
            if (isLoading) {
                rewriteButton.disabled = true;
                loadingIndicator.classList.remove('hidden');
                outputText.value = 'تتم الصياغة الآن... يرجى الانتظار...';
                errorMessage.textContent = '';
            } else {
                rewriteButton.disabled = false;
                loadingIndicator.classList.add('hidden');
            }
        }

        /**
         * دالة لنسخ النص إلى الحافظة
         * (تستخدم document.execCommand حسب التعليمات)
         */
        function copyToClipboard() {
            if (!outputText.value) return;

            outputText.select();
            // للعمل على الأجهزة المحمولة
            outputText.setSelectionRange(0, 99999); 

            try {
                document.execCommand('copy');
                copyButton.textContent = 'تم النسخ!';
                setTimeout(() => { copyButton.textContent = 'نسخ النص'; }, 2000);
            } catch (err) {
                console.error('Failed to copy text: ', err);
                errorMessage.textContent = "فشل النسخ. يرجى النسخ يدويًا.";
            }
            
            // إلغاء التحديد
            window.getSelection().removeAllRanges();
        }

        // ربط الأحداث بالأزرار
        rewriteButton.addEventListener('click', handleRewrite);
        copyButton.addEventListener('click', copyToClipboard);

    </script>
</body>
</html>


